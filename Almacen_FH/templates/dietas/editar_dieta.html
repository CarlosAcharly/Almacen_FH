{% extends "layout/base.html" %}
{% load dietas_extras %}  <!-- ¬°CARGAR LOS FILTROS AQU√ç! -->

{% block title %}Editar Dieta: {{ dieta.nombre }}{% endblock %}

{% block content %}

<div class="container-fluid">
    <!-- BREADCRUMB -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'lista_dietas' %}">Dietas</a></li>
            <li class="breadcrumb-item active">Editar: {{ dieta.nombre }}</li>
        </ol>
    </nav>
    
    <div class="row">
        <!-- COLUMNA IZQUIERDA: INGREDIENTES -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìù Ingredientes de la dieta</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formIngredientes">
                        {% csrf_token %}
                        <input type="hidden" name="guardar_ingredientes" value="1">
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ingrediente</th>
                                        <th width="180" class="text-center">Cantidad (kg)</th>
                                        <th width="120" class="text-center">Stock Disponible</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ingrediente in ingredientes %}
                                    <tr>
                                        <td>
                                            <strong>{{ ingrediente.nombre }}</strong>
                                        </td>
                                        <td>
                                            <!-- USO CORRECTO DEL FILTRO get_item -->
                                            <input type="number"
                                                   step="0.01"
                                                   min="0"
                                                   name="kg_{{ ingrediente.id }}"
                                                   class="form-control kg-input text-center"
                                                   value="{{ detalles|get_item:ingrediente.id|default:0 }}">
                                        </td>
                                        <td class="text-center">
                                            <span class="badge {% if ingrediente.stock_kg > 0 %}bg-info{% else %}bg-danger{% endif %}">
                                                {{ ingrediente.stock_kg }} kg
                                            </span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-4">
                                            No hay ingredientes registrados en el sistema
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th class="text-end">Total de la dieta:</th>
                                        <th class="text-center">
                                            <span id="totalDieta" class="fw-bold h5">
                                                {{ total_actual|floatformat:2 }} kg
                                            </span>
                                        </th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="mt-3 d-flex gap-2">
                            <button type="button"
                                    class="btn btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalGuardarIngredientes">
                                üíæ Guardar ingredientes
                            </button>
                            <a href="{% url 'lista_dietas' %}" class="btn btn-outline-secondary">
                                ‚Üê Volver a lista
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- HISTORIAL DE PREPARACIONES -->
            {% if preparaciones %}
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üìã Historial de preparaciones</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Usuario</th>
                                    <th>Cantidad</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prep in preparaciones %}
                                <tr>
                                    <td>{{ prep.fecha_hora|date:"d/m/Y H:i" }}</td>
                                    <td>{{ prep.usuario.username }}</td>
                                    <td><strong>{{ prep.cantidad_preparada }} kg</strong></td>
                                    <td>{{ prep.observaciones|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">
                            Total preparado: {{ dieta.producto_dieta.stock_kg }} kg
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- COLUMNA DERECHA: INFORMACI√ìN Y ACCIONES -->
        <div class="col-lg-4">
            <!-- INFORMACI√ìN DE LA DIETA -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìã Informaci√≥n de la dieta</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formInfo">
                        {% csrf_token %}
                        <input type="hidden" name="actualizar_info" value="1">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nombre de la dieta</label>
                            {{ form.nombre|add_class:"form-control" }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Etapa</label>
                            {{ form.etapa|add_class:"form-select" }}
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Producto asociado</label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control bg-light" 
                                       value="{{ dieta.producto_dieta.nombre }}"
                                       readonly>
                                <span class="input-group-text">
                                    Stock: <strong class="ms-1">{{ dieta.producto_dieta.stock_kg }} kg</strong>
                                </span>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button"
                                    class="btn btn-info"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalActualizarInfo">
                                üìù Actualizar informaci√≥n
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- PREPARAR DIETA -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚öôÔ∏è Preparar dieta</h5>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'preparar_dieta' dieta.id %}" id="formPreparar">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Cantidad a preparar</label>
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control text-center fw-bold" 
                                       value="{{ dieta.total_kg }} kg"
                                       readonly>
                                <span class="input-group-text">Total</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Observaciones (opcional)</label>
                            <textarea name="observaciones" 
                                      class="form-control" 
                                      rows="3"
                                      placeholder="Ej: Preparaci√≥n para el lote #15..."></textarea>
                        </div>
                        
                        <div class="alert alert-warning small">
                            <strong>‚ö†Ô∏è Esta acci√≥n realizar√°:</strong><br>
                            1. Descuento de stock de ingredientes<br>
                            2. Registro de salida tipo VENTA<br>
                            3. Aumento de stock del producto dieta<br>
                            4. Registro de entrada autom√°tica<br>
                            5. Se puede repetir m√∫ltiples veces
                        </div>
                        
                        <div class="d-grid">
                            <button type="button"
                                    class="btn btn-success"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalPreparar">
                                ‚öôÔ∏è Preparar dieta ahora
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- ESTADO DE LA DIETA -->
            <div class="card shadow-sm mt-4">
                <div class="card-body text-center">
                    <h6 class="mb-3">üìä Resumen</h6>
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-2 border rounded">
                                <small class="text-muted d-block">Ingredientes</small>
                                <span class="h4">{{ dieta.detalles.count }}</span>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-2 border rounded">
                                <small class="text-muted d-block">Preparaciones</small>
                                <span class="h4">{{ dieta.preparaciones.count }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded">
                                <small class="text-muted d-block">Stock producto</small>
                                <span class="h4">{{ dieta.producto_dieta.stock_kg|floatformat:0 }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded">
                                <small class="text-muted d-block">Total dieta</small>
                                <span class="h4">{{ dieta.total_kg|floatformat:0 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES DE CONFIRMACI√ìN -->
<!-- Modal Guardar Ingredientes -->
<div class="modal fade" id="modalGuardarIngredientes" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üíæ Guardar ingredientes</h5>
            </div>
            <div class="modal-body">
                <p>¬øSeguro que deseas guardar los cambios en los ingredientes?</p>
                <div class="alert alert-info small">
                    Esta acci√≥n <strong>no afecta el stock</strong>. Solo guarda la receta de la dieta.
                    El stock se descontar√° al preparar la dieta.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('formIngredientes').submit()">
                    S√≠, guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Actualizar Informaci√≥n -->
<div class="modal fade" id="modalActualizarInfo" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìù Actualizar informaci√≥n</h5>
            </div>
            <div class="modal-body">
                ¬øSeguro que deseas actualizar la informaci√≥n de la dieta?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-info" onclick="document.getElementById('formInfo').submit()">
                    S√≠, actualizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preparar Dieta -->
<div class="modal fade" id="modalPreparar" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚öôÔ∏è Preparar dieta</h5>
            </div>
            <div class="modal-body">
                <p><strong>¬øEst√°s seguro de preparar esta dieta?</strong></p>
                
                <div class="alert alert-warning">
                    <p class="mb-1"><strong>Cantidad a preparar:</strong> {{ dieta.total_kg }} kg</p>
                    <p class="mb-0"><strong>Producto generado:</strong> {{ dieta.producto_dieta.nombre }}</p>
                </div>
                
                <div class="alert alert-danger">
                    <small>
                        <strong>‚ö†Ô∏è Esta acci√≥n NO se puede deshacer autom√°ticamente.</strong><br>
                        Se afectar√° el stock de ingredientes y se registrar√°n movimientos.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="document.getElementById('formPreparar').submit()">
                    S√≠, preparar ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT PARA CALCULAR TOTAL -->
<script>
function recalcularTotal() {
    let total = 0;
    document.querySelectorAll('.kg-input').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    document.getElementById('totalDieta').textContent = total.toFixed(2) + ' kg';
}

// Calcular total al cargar y al cambiar valores
document.addEventListener('DOMContentLoaded', recalcularTotal);
document.querySelectorAll('.kg-input').forEach(input => {
    input.addEventListener('input', recalcularTotal);
});
</script>

{% endblock %}