{% extends "layout/base.html" %}
{% block content %}
<div class="container mt-4">
    <h1>Crear Salida</h1>

    <form method="post">
        {% csrf_token %}

        {% if form.errors %}
        <div class="alert alert-danger">
            <ul>
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if formset.non_form_errors %}
        <div class="alert alert-danger">
            {% for error in formset.non_form_errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <div class="mb-3">{{ form.tipo.label_tag }} {{ form.tipo }}</div>
        <div class="mb-3">{{ form.cliente.label_tag }} {{ form.cliente }}</div>
        <div class="mb-3">{{ form.lugar.label_tag }} {{ form.lugar }}</div>
        <div class="mb-3">{{ form.chofer.label_tag }} {{ form.chofer }}</div>
        <div class="mb-3">{{ form.unidad.label_tag }} {{ form.unidad }}</div>

        <h4>Productos</h4>
        {{ formset.management_form }}

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Kg</th>
                    <th>Ton</th>
                    <th>Bultos</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="formset-body">
                {% for f in formset %}
                <tr class="formset-row">
                    <td>{{ f.producto }}</td>
                    <td>{{ f.kg }}</td>
                    <td>{{ f.toneladas }}</td>
                    <td>{{ f.bultos }}</td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm remove-row">X</button>
                    </td>
                </tr>
                {% endfor %}

                <tr id="formset-empty" class="formset-row d-none">
                    <td>
                        <select name="detalles-__prefix__-producto" class="form-select">
                            {% for producto in productos %}
                            <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" step="0.01" name="detalles-__prefix__-kg" class="form-control"></td>
                    <td><input type="number" step="0.01" name="detalles-__prefix__-toneladas" class="form-control"></td>
                    <td><input type="number" step="1" name="detalles-__prefix__-bultos" class="form-control"></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row">X</button></td>
                </tr>
            </tbody>
        </table>

        <button type="button" id="add-row" class="btn btn-primary">Agregar producto</button>
        <button type="submit" class="btn btn-success">Guardar salida</button>
    </form>
</div>

<!-- MODAL POS -->
<div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salida registrada</h5>
            </div>
            <div class="modal-body">
                ¿Deseas imprimir el ticket?
            </div>
            <div class="modal-footer">
                <a class="btn btn-primary" id="print-ticket-btn">Sí</a>
                <button class="btn btn-secondary" id="cancel-ticket-btn">No</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ===== FORMSET ===== */
    const tbody = document.getElementById("formset-body");
    const totalForms = document.getElementById("id_detalles-TOTAL_FORMS");
    const addBtn = document.getElementById("add-row");
    const template = document.getElementById("formset-empty");

    function refreshRemove() {
        document.querySelectorAll(".remove-row").forEach(btn => {
            btn.onclick = () => {
                btn.closest("tr").remove();
                totalForms.value = tbody.querySelectorAll(".formset-row:not(#formset-empty)").length;
            };
        });
    }
    refreshRemove();

    addBtn.onclick = () => {
        const index = parseInt(totalForms.value);
        const row = template.cloneNode(true);
        row.classList.remove("d-none");
        row.removeAttribute("id");

        row.querySelectorAll("input,select").forEach(el => {
            el.name = el.name.replace("__prefix__", index);
            el.value = "";
        });

        tbody.appendChild(row);
        totalForms.value = index + 1;
        refreshRemove();
    };

    /* ===== MODAL POS ===== */
    {% if ticket_id %}
    const modal = new bootstrap.Modal(document.getElementById("ticketModal"));
    modal.show();

    const printBtn = document.getElementById("print-ticket-btn");
    const cancelBtn = document.getElementById("cancel-ticket-btn");

    printBtn.href = "{% url 'imprimir_ticket' ticket_id %}";

    cancelBtn.onclick = () => {
        window.location.href = "{% url 'lista_salidas' %}";
    };

    printBtn.onclick = function (e) {
        e.preventDefault();

        const win = window.open(
            this.href,
            "POS",
            "width=320,height=600,menubar=no,toolbar=no,location=no,status=no"
        );

        win.focus();

        const timer = setInterval(() => {
            if (win.closed) {
                clearInterval(timer);
                window.location.href = "{% url 'lista_salidas' %}";
            }
        }, 500);
    };
    {% endif %}
});
</script>
{% endblock %}
